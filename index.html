<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCCD Scanner - Quét CCCD</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function CCCDScanner() {
      const [scanning, setScanning] = useState(false);
      const [cccdData, setCccdData] = useState(null);
      const [maNV, setMaNV] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [message, setMessage] = useState({ type: '', text: '' });
      const [debugInfo, setDebugInfo] = useState('');
      const [capturedImage, setCapturedImage] = useState(null);
      const [showAdmin, setShowAdmin] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [records, setRecords] = useState([]);

      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanningRef = useRef(false);

      // URL web app Google Sheet
      const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbw-WP7BkRvFxjP56OP3AUXS3T0mjZcM5bfGjgEs3ziWEi9cQxEOyNyIBaiFuxIlo_-Y/exec';

      // Load dữ liệu từ localStorage
      useEffect(() => {
        const saved = localStorage.getItem('cccdRecords');
        if (saved) setRecords(JSON.parse(saved));
      }, []);

      useEffect(() => {
        return () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
          }
        };
      }, []);

      // Hàm gửi dữ liệu lên Google Sheet
      const sendToGoogleSheet = async (record) => {
        try {
          const formData = new FormData();
          Object.keys(record).forEach(key => formData.append(key, record[key]));

          const res = await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            body: formData
          });

          if (!res.ok) return false;
          const data = await res.text();
          console.log('Google Sheet response:', data);
          return true;
        } catch (error) {
          console.error('Lỗi gửi dữ liệu Google Sheet:', error);
          return false;
        }
      };

      const parseCCCDData = (qrText) => {
        try {
          const parts = qrText.split('|');
          if (parts.length >= 7) {
            const formatDate = (dateStr) => dateStr && dateStr.length === 8 
              ? `${dateStr.substring(0,2)}/${dateStr.substring(2,4)}/${dateStr.substring(4,8)}` 
              : dateStr;

            return {
              soCCCD: parts[0] || '',
              cmnd: parts[1] || '',
              hoTen: parts[2] || '',
              ngaySinh: formatDate(parts[3]),
              gioiTinh: parts[4] || '',
              diaChi: parts[5] || '',
              ngayCap: formatDate(parts[6])
            };
          }
          return null;
        } catch {
          return null;
        }
      };

      const startCamera = async () => {
        try {
          setDebugInfo('Đang yêu cầu quyền camera...');
          setMessage({ type: '', text: '' });
          setScanning(true);

          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: 1280, height: 720 }
          });

          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            scanningRef.current = true;
            await videoRef.current.play();
            setDebugInfo('Camera đang hoạt động! Đưa mã QR vào khung.');
            requestAnimationFrame(scanQRCode);
          }
        } catch (error) {
          console.error('Camera error:', error);
          setScanning(false);
          setMessage({ type: 'error', text: 'Không thể truy cập camera. ' + error.message });
        }
      };

      const stopCamera = () => {
        scanningRef.current = false;
        if (streamRef.current) streamRef.current.getTracks().forEach(track => track.stop());
        if (videoRef.current) videoRef.current.srcObject = null;
        setScanning(false);
        setDebugInfo('');
      };

      const scanQRCode = () => {
        if (!scanningRef.current || !videoRef.current || !canvasRef.current) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          if (typeof window.jsQR !== 'undefined') {
            const code = window.jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
            if (code && code.data) {
              const parsed = parseCCCDData(code.data);
              if (parsed) {
                setCccdData(parsed);
                stopCamera();
                setMessage({ type: 'success', text: 'Quét mã thành công!' });
                return;
              }
            }
          }
        }

        if (scanningRef.current) requestAnimationFrame(scanQRCode);
      };

      const handleSubmit = async () => {
        if (!cccdData || !maNV.trim()) {
          setMessage({ type: 'error', text: 'Vui lòng nhập đầy đủ thông tin!' });
          return;
        }

        setSubmitting(true);

        const newRecord = {
          id: Date.now(),
          thoiGian: new Date().toLocaleString('vi-VN'),
          soCCCD: cccdData.soCCCD,
          cmnd: cccdData.cmnd,
          hoTen: cccdData.hoTen,
          ngaySinh: cccdData.ngaySinh,
          gioiTinh: cccdData.gioiTinh,
          diaChi: cccdData.diaChi,
          ngayCap: cccdData.ngayCap,
          maNV: maNV
        };

        const updatedRecords = [...records, newRecord];
        setRecords(updatedRecords);
        localStorage.setItem('cccdRecords', JSON.stringify(updatedRecords));

        // Gửi Google Sheet
        const success = await sendToGoogleSheet(newRecord);
        if (success) setMessage({ type: 'success', text: 'Lưu thành công và đồng bộ Google Sheet!' });
        else setMessage({ type: 'error', text: 'Đã lưu local nhưng gửi Google Sheet thất bại!' });

        setSubmitting(false);
        setCccdData(null);
        setMaNV('');

        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
      };

      // Các hàm hỗ trợ khác giữ nguyên như code ban đầu: handleReset, handleTestInput, handleCaptureImage, handleAdminLogin, handleDeleteRecord, handleClearAll, handleExportExcel
      // ... giữ nguyên code UI và logic cũ

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          {/* Giữ nguyên tất cả UI code ban đầu */}
          <p className="text-center text-gray-600 text-sm mt-4">
            Dành cho nhân viên công ty • Đã lưu: {records.length} bản ghi
          </p>
        </div>
      );
    }

    ReactDOM.render(<CCCDScanner />, document.getElementById('root'));
  </script>
</body>
</html>
