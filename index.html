<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCCD Scanner - Qu√©t CCCD</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    
    function CCCDScanner() {
      const [scanning, setScanning] = useState(false);
      const [cccdData, setCccdData] = useState(null);
      const [maNV, setMaNV] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [message, setMessage] = useState({ type: '', text: '' });
      const [debugInfo, setDebugInfo] = useState('');
      const [showAdmin, setShowAdmin] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [records, setRecords] = useState([]);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanningRef = useRef(false);

      // Load d·ªØ li·ªáu t·ª´ localStorage
      useEffect(() => {
        const saved = localStorage.getItem('cccdRecords');
        if (saved) {
          setRecords(JSON.parse(saved));
        }
      }, []);

      useEffect(() => {
        return () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
          }
        };
      }, []);

      const parseCCCDData = (qrText) => {
        try {
          const parts = qrText.split('|');
          if (parts.length >= 7) {
            return {
              soCCCD: parts[0],
              cmnd: parts[1],
              hoTen: parts[2],
              ngaySinh: parts[3],
              gioiTinh: parts[4],
              diaChi: parts[5],
              ngayCap: parts[6]
            };
          }
          return null;
        } catch (error) {
          return null;
        }
      };

      const startCamera = async () => {
        try {
          setDebugInfo('ƒêang y√™u c·∫ßu quy·ªÅn camera...');
          setMessage({ type: '', text: '' });
          
          // B·∫≠t scanning ngay ƒë·ªÉ hi·ªÉn th·ªã UI
          setScanning(true);
          
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: { ideal: 'environment' },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });
          
          setDebugInfo('ƒê√£ c√≥ quy·ªÅn camera, ƒëang kh·ªüi ƒë·ªông video...');
          
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            scanningRef.current = true;
            
            // ƒê·ª£i video s·∫µn s√†ng
            await videoRef.current.play();
            setDebugInfo('Camera ƒëang ho·∫°t ƒë·ªông! ƒê∆∞a m√£ QR v√†o khung.');
            
            // B·∫Øt ƒë·∫ßu qu√©t
            requestAnimationFrame(scanQRCode);
          }
        } catch (error) {
          console.error('Camera error:', error);
          setScanning(false);
          setDebugInfo('L·ªói: ' + error.name + ' - ' + error.message);
          let errorMsg = 'Kh√¥ng th·ªÉ truy c·∫≠p camera. ';
          if (error.name === 'NotAllowedError') {
            errorMsg += 'Vui l√≤ng c·∫•p quy·ªÅn camera trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.';
          } else if (error.name === 'NotFoundError') {
            errorMsg += 'Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã.';
          } else if (error.name === 'NotReadableError') {
            errorMsg += 'Camera ƒëang ƒë∆∞·ª£c ·ª©ng d·ª•ng kh√°c s·ª≠ d·ª•ng.';
          } else {
            errorMsg += error.message;
          }
          setMessage({ type: 'error', text: errorMsg });
        }
      };

      const stopCamera = () => {
        scanningRef.current = false;
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        if (videoRef.current) {
          videoRef.current.srcObject = null;
        }
        setScanning(false);
        setDebugInfo('');
      };

      const scanQRCode = () => {
        if (!scanningRef.current || !videoRef.current || !canvasRef.current) {
          return;
        }

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          if (canvas.width > 0 && canvas.height > 0) {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            if (typeof jsQR !== 'undefined') {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "attemptBoth",
              });

              if (code && code.data) {
                setDebugInfo('ƒê√£ ph√°t hi·ªán m√£ QR: ' + code.data.substring(0, 50) + '...');
                const parsed = parseCCCDData(code.data);
                if (parsed) {
                  setCccdData(parsed);
                  stopCamera();
                  setMessage({ type: 'success', text: 'Qu√©t m√£ th√†nh c√¥ng!' });
                  return;
                } else {
                  setDebugInfo('M√£ QR kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng CCCD. Th·ª≠ l·∫°i...');
                }
              }
            }
          }
        }

        if (scanningRef.current) {
          requestAnimationFrame(scanQRCode);
        }
      };

      const handleSubmit = () => {
        if (!cccdData || !maNV.trim()) {
          setMessage({ type: 'error', text: 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!' });
          return;
        }

        setSubmitting(true);

        const newRecord = {
          id: Date.now(),
          thoiGian: new Date().toLocaleString('vi-VN'),
          soCCCD: cccdData.soCCCD,
          hoTen: cccdData.hoTen,
          ngaySinh: cccdData.ngaySinh,
          gioiTinh: cccdData.gioiTinh,
          diaChi: cccdData.diaChi,
          ngayCap: cccdData.ngayCap,
          maNV: maNV
        };

        const updatedRecords = [...records, newRecord];
        setRecords(updatedRecords);
        localStorage.setItem('cccdRecords', JSON.stringify(updatedRecords));

        setMessage({ type: 'success', text: 'L∆∞u th√¥ng tin th√†nh c√¥ng!' });
        setSubmitting(false);
        setCccdData(null);
        setMaNV('');
        
        setTimeout(() => {
          setMessage({ type: '', text: '' });
        }, 3000);
      };

      const handleTestInput = () => {
        const testData = '075400109724|273719287|Ng√¥ Th·ªã Lan|12102006|Nam|165, T·ªï 43, Kp T√¢n Th·∫°nh 2, Bi√™n H√≤a, ƒê·ªìng Nai|28102024';
        const parsed = parseCCCDData(testData);
        if (parsed) {
          setCccdData(parsed);
          setMessage({ type: 'success', text: 'ƒê√£ load d·ªØ li·ªáu test!' });
        }
      };

      const handleReset = () => {
        setCccdData(null);
        setMaNV('');
        setMessage({ type: '', text: '' });
      };

      const handleAdminLogin = () => {
        if (adminPassword === 'admin123') {
          setShowAdmin(true);
          setAdminPassword('');
          setMessage({ type: '', text: '' });
        } else {
          setMessage({ type: 'error', text: 'Sai m·∫≠t kh·∫©u!' });
        }
      };

      const handleExportExcel = () => {
        if (records.length === 0) {
          setMessage({ type: 'error', text: 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ export!' });
          return;
        }

        const worksheet = XLSX.utils.json_to_sheet(records.map(r => ({
          'Th·ªùi gian': r.thoiGian,
          'S·ªë CCCD': r.soCCCD,
          'H·ªç t√™n': r.hoTen,
          'Ng√†y sinh': r.ngaySinh,
          'Gi·ªõi t√≠nh': r.gioiTinh,
          'ƒê·ªãa ch·ªâ': r.diaChi,
          'Ng√†y c·∫•p': r.ngayCap,
          'M√£ NV': r.maNV
        })));

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Danh s√°ch');
        XLSX.writeFile(workbook, `CCCD_Records_${new Date().toLocaleDateString('vi-VN')}.xlsx`);
        
        setMessage({ type: 'success', text: 'ƒê√£ t·∫£i file Excel!' });
      };

      const handleDeleteRecord = (id) => {
        const updatedRecords = records.filter(r => r.id !== id);
        setRecords(updatedRecords);
        localStorage.setItem('cccdRecords', JSON.stringify(updatedRecords));
        setMessage({ type: 'success', text: 'ƒê√£ x√≥a!' });
      };

      const handleClearAll = () => {
        if (window.confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
          setRecords([]);
          localStorage.removeItem('cccdRecords');
          setMessage({ type: 'success', text: 'ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!' });
        }
      };

      if (showAdmin) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4">
            <div className="max-w-6xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div className="bg-gradient-to-r from-slate-700 to-slate-900 p-6 text-white">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-2xl font-bold">Qu·∫£n l√Ω d·ªØ li·ªáu CCCD</h1>
                      <p className="text-slate-300 text-sm mt-1">T·ªïng: {records.length} b·∫£n ghi</p>
                    </div>
                    <button
                      onClick={() => setShowAdmin(false)}
                      className="px-4 py-2 bg-white text-slate-800 rounded-lg font-medium hover:bg-slate-100 transition"
                    >
                      ƒê√≥ng
                    </button>
                  </div>
                </div>

                <div className="p-6">
                  {message.text && (
                    <div className={`mb-4 p-4 rounded-lg ${
                      message.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
                    }`}>
                      {message.text}
                    </div>
                  )}

                  <div className="flex gap-3 mb-6">
                    <button
                      onClick={handleExportExcel}
                      className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition flex items-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      T·∫£i Excel
                    </button>
                    <button
                      onClick={handleClearAll}
                      className="px-6 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition"
                    >
                      X√≥a t·∫•t c·∫£
                    </button>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-100">
                        <tr>
                          <th className="px-4 py-3 text-left font-semibold">Th·ªùi gian</th>
                          <th className="px-4 py-3 text-left font-semibold">S·ªë CCCD</th>
                          <th className="px-4 py-3 text-left font-semibold">H·ªç t√™n</th>
                          <th className="px-4 py-3 text-left font-semibold">Ng√†y sinh</th>
                          <th className="px-4 py-3 text-left font-semibold">Gi·ªõi t√≠nh</th>
                          <th className="px-4 py-3 text-left font-semibold">M√£ NV</th>
                          <th className="px-4 py-3 text-left font-semibold">Thao t√°c</th>
                        </tr>
                      </thead>
                      <tbody>
                        {records.length === 0 ? (
                          <tr>
                            <td colSpan="7" className="px-4 py-8 text-center text-gray-500">
                              Ch∆∞a c√≥ d·ªØ li·ªáu
                            </td>
                          </tr>
                        ) : (
                          records.map(record => (
                            <tr key={record.id} className="border-t hover:bg-slate-50">
                              <td className="px-4 py-3">{record.thoiGian}</td>
                              <td className="px-4 py-3">{record.soCCCD}</td>
                              <td className="px-4 py-3">{record.hoTen}</td>
                              <td className="px-4 py-3">{record.ngaySinh}</td>
                              <td className="px-4 py-3">{record.gioiTinh}</td>
                              <td className="px-4 py-3 font-medium">{record.maNV}</td>
                              <td className="px-4 py-3">
                                <button
                                  onClick={() => handleDeleteRecord(record.id)}
                                  className="text-red-600 hover:text-red-800 font-medium"
                                >
                                  X√≥a
                                </button>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-md mx-auto">
            <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                <h1 className="text-2xl font-bold text-center">Qu√©t CCCD</h1>
                <p className="text-center text-blue-100 text-sm mt-1">H·ªá th·ªëng nh·∫≠n di·ªán nh√¢n vi√™n</p>
              </div>

              <div className="p-6">
                {debugInfo && (
                  <div className="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-xs">
                    <strong>Debug:</strong> {debugInfo}
                  </div>
                )}

                {message.text && (
                  <div className={`mb-4 p-4 rounded-lg flex items-center gap-2 ${
                    message.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
                  }`}>
                    <span className="text-sm">{message.text}</span>
                  </div>
                )}

                {scanning && (
                  <div className="mb-6">
                    <div className="relative bg-black rounded-lg overflow-hidden" style={{ aspectRatio: '4/3' }}>
                      <video
                        ref={videoRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-64 h-64 border-2 border-white rounded-lg opacity-70"></div>
                      </div>
                      <div className="absolute bottom-4 left-4 right-4 text-white text-center text-sm bg-black bg-opacity-50 p-2 rounded">
                        ƒê·∫∑t m√£ QR v√†o khung vu√¥ng
                      </div>
                    </div>
                    <canvas ref={canvasRef} className="hidden" />
                    <button
                      onClick={stopCamera}
                      className="w-full mt-3 px-4 py-3 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition"
                    >
                      D·ª´ng qu√©t
                    </button>
                  </div>
                )}

                {!scanning && !cccdData && (
                  <div className="space-y-3">
                    <button
                      onClick={startCamera}
                      className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition flex items-center justify-center gap-2"
                    >
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      Qu√©t m√£ QR CCCD
                    </button>
                    
                    <button
                      onClick={handleTestInput}
                      className="w-full px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition text-sm"
                    >
                      üß™ Test v·ªõi d·ªØ li·ªáu m·∫´u
                    </button>
                  </div>
                )}

                {cccdData && (
                  <div className="space-y-4 mb-6">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h3 className="font-semibold text-green-800 mb-3">Th√¥ng tin CCCD:</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex">
                          <span className="font-medium w-32">S·ªë CCCD:</span>
                          <span>{cccdData.soCCCD}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">H·ªç t√™n:</span>
                          <span>{cccdData.hoTen}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Ng√†y sinh:</span>
                          <span>{cccdData.ngaySinh}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Gi·ªõi t√≠nh:</span>
                          <span>{cccdData.gioiTinh}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">ƒê·ªãa ch·ªâ:</span>
                          <span className="flex-1">{cccdData.diaChi}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Ng√†y c·∫•p:</span>
                          <span>{cccdData.ngayCap}</span>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        M√£ s·ªë nh√¢n vi√™n <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={maNV}
                        onChange={(e) => setMaNV(e.target.value)}
                        placeholder="Nh·∫≠p m√£ NV"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                      />
                    </div>

                    <div className="flex gap-3">
                      <button
                        onClick={handleReset}
                        className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                      >
                        Qu√©t l·∫°i
                      </button>
                      <button
                        onClick={handleSubmit}
                        disabled={submitting}
                        className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition disabled:opacity-50 flex items-center justify-center gap-2"
                      >
                        {submitting ? (
                          <span>ƒêang l∆∞u...</span>
                        ) : (
                          <>
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            L∆∞u
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}

                <div className="mt-6 pt-6 border-t space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      M·∫≠t kh·∫©u HR (ƒë·ªÉ xem d·ªØ li·ªáu)
                    </label>
                    <input
                      type="password"
                      value={adminPassword}
                      onChange={(e) => setAdminPassword(e.target.value)}
                      placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                    />
                  </div>
                  <button
                    onClick={handleAdminLogin}
                    className="w-full px-4 py-3 bg-slate-700 text-white rounded-lg font-medium hover:bg-slate-800 transition"
                  >
                    üîí Xem d·ªØ li·ªáu (HR)
                  </button>
                  <p className="text-xs text-gray-500 text-center">
                    M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: admin123
                  </p>
                </div>
              </div>
            </div>

            <p className="text-center text-gray-600 text-sm mt-4">
              D√†nh cho nh√¢n vi√™n c√¥ng ty ‚Ä¢ ƒê√£ l∆∞u: {records.length} b·∫£n ghi
            </p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<CCCDScanner />, document.getElementById('root'));
  </script>
</body>
</html>
