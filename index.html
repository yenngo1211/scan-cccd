<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCCD Scanner - Quét CCCD</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
    
    function CCCDScanner() {
      const [scanning, setScanning] = useState(false);
      const [cccdData, setCccdData] = useState(null);
      const [maNV, setMaNV] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [message, setMessage] = useState({ type: '', text: '' });
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);

      useEffect(() => {
        return () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
          }
        };
      }, []);

      const parseCCCDData = (qrText) => {
        try {
          const parts = qrText.split('|');
          if (parts.length >= 7) {
            return {
              soCCCD: parts[0],
              cmnd: parts[1],
              hoTen: parts[2],
              ngaySinh: parts[3],
              gioiTinh: parts[4],
              diaChi: parts[5],
              ngayCap: parts[6]
            };
          }
          return null;
        } catch (error) {
          return null;
        }
      };

      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            setScanning(true);
            scanQRCode();
          }
        } catch (error) {
          setMessage({ type: 'error', text: 'Không thể truy cập camera. Vui lòng cấp quyền.' });
        }
      };

      const stopCamera = () => {
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        if (videoRef.current) {
          videoRef.current.srcObject = null;
        }
        setScanning(false);
      };

      const scanQRCode = async () => {
        if (!scanning || !videoRef.current || !canvasRef.current) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            const parsed = parseCCCDData(code.data);
            if (parsed) {
              setCccdData(parsed);
              stopCamera();
              setMessage({ type: 'success', text: 'Quét mã thành công!' });
              return;
            }
          }
        }

        if (scanning) {
          requestAnimationFrame(scanQRCode);
        }
      };

      const handleSubmit = async () => {
        if (!cccdData || !maNV.trim()) {
          setMessage({ type: 'error', text: 'Vui lòng nhập đầy đủ thông tin!' });
          return;
        }

        setSubmitting(true);
        setMessage({ type: '', text: '' });

        try {
          const formData = new FormData();
          formData.append('soCCCD', cccdData.soCCCD);
          formData.append('hoTen', cccdData.hoTen);
          formData.append('ngaySinh', cccdData.ngaySinh);
          formData.append('gioiTinh', cccdData.gioiTinh);
          formData.append('diaChi', cccdData.diaChi);
          formData.append('ngayCap', cccdData.ngayCap);
          formData.append('maNV', maNV);
          formData.append('thoiGian', new Date().toLocaleString('vi-VN'));

          const response = await fetch('https://script.google.com/macros/s/AKfycbxxEvzS7p2PUFS3yd8tiaGTGfJftaZI_p0TjNpxeRRAa3TGNFzRkW0-oRvWrY8kWyo9/exec', {
            method: 'POST',
            mode: 'no-cors',
            body: formData
          });

          setMessage({ type: 'success', text: 'Gửi thông tin thành công!' });
          setCccdData(null);
          setMaNV('');
        } catch (error) {
          setMessage({ type: 'error', text: 'Lỗi khi gửi dữ liệu. Vui lòng thử lại.' });
        } finally {
          setSubmitting(false);
        }
      };

      const handleReset = () => {
        setCccdData(null);
        setMaNV('');
        setMessage({ type: '', text: '' });
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-md mx-auto">
            <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                <h1 className="text-2xl font-bold text-center">Quét CCCD</h1>
                <p className="text-center text-blue-100 text-sm mt-1">Hệ thống nhận diện nhân viên</p>
              </div>

              <div className="p-6">
                {message.text && (
                  <div className={`mb-4 p-4 rounded-lg flex items-center gap-2 ${
                    message.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
                  }`}>
                    <span className="text-sm">{message.text}</span>
                  </div>
                )}

                {scanning && (
                  <div className="mb-6">
                    <div className="relative bg-black rounded-lg overflow-hidden" style={{ aspectRatio: '4/3' }}>
                      <video
                        ref={videoRef}
                        autoPlay
                        playsInline
                        muted
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute inset-0 border-4 border-blue-500 opacity-50"></div>
                      <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-2 border-white rounded-lg"></div>
                    </div>
                    <canvas ref={canvasRef} className="hidden" />
                    <button
                      onClick={stopCamera}
                      className="w-full mt-3 px-4 py-3 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition"
                    >
                      Dừng quét
                    </button>
                  </div>
                )}

                {!scanning && !cccdData && (
                  <button
                    onClick={startCamera}
                    className="w-full mb-6 px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition flex items-center justify-center gap-2"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Quét mã QR CCCD
                  </button>
                )}

                {cccdData && (
                  <div className="space-y-4 mb-6">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h3 className="font-semibold text-green-800 mb-3">Thông tin CCCD:</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex">
                          <span className="font-medium w-32">Số CCCD:</span>
                          <span>{cccdData.soCCCD}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Họ tên:</span>
                          <span>{cccdData.hoTen}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Ngày sinh:</span>
                          <span>{cccdData.ngaySinh}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Giới tính:</span>
                          <span>{cccdData.gioiTinh}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Địa chỉ:</span>
                          <span className="flex-1">{cccdData.diaChi}</span>
                        </div>
                        <div className="flex">
                          <span className="font-medium w-32">Ngày cấp:</span>
                          <span>{cccdData.ngayCap}</span>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Mã số nhân viên <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={maNV}
                        onChange={(e) => setMaNV(e.target.value)}
                        placeholder="Nhập mã NV"
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                      />
                    </div>

                    <div className="flex gap-3">
                      <button
                        onClick={handleReset}
                        className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                      >
                        Quét lại
                      </button>
                      <button
                        onClick={handleSubmit}
                        disabled={submitting}
                        className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition disabled:opacity-50 flex items-center justify-center gap-2"
                      >
                        {submitting ? (
                          <span>Đang gửi...</span>
                        ) : (
                          <>
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                            Gửi
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <p className="text-center text-gray-600 text-sm mt-4">
              Dành cho nhân viên công ty
            </p>
          </div>
        </div>
      );
    }

    ReactDOM.render(<CCCDScanner />, document.getElementById('root'));
  </script>
</body>
</html>
