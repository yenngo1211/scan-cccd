<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCCD Scanner - Google Sheets</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function CCCDScanner() {
      const [scanning, setScanning] = useState(false);
      const [cccdData, setCccdData] = useState(null);
      const [maNV, setMaNV] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [message, setMessage] = useState({ type: '', text: '' });
      const [debugInfo, setDebugInfo] = useState('');
      const [capturedImage, setCapturedImage] = useState(null);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const streamRef = useRef(null);
      const scanningRef = useRef(false);

      const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw-WP7BkRvFxjP56OP3AUXS3T0mjZcM5bfGjgEs3ziWEi9cQxEOyNyIBaiFuxIlo_-Y/exec";

      useEffect(() => {
        if (typeof jsQR !== 'undefined') {
          setDebugInfo('jsQR library ƒë√£ s·∫µn s√†ng ‚úì');
        } else {
          setDebugInfo('ƒêang t·∫£i jsQR library...');
        }
      }, []);

      useEffect(() => {
        return () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
          }
        };
      }, []);

      const parseCCCDData = (qrText) => {
        try {
          const parts = qrText.split('|');
          if (parts.length >= 7) {
            const formatDate = (dateStr) => {
              if (dateStr && dateStr.length === 8) {
                return `${dateStr.substring(0,2)}/${dateStr.substring(2,4)}/${dateStr.substring(4,8)}`;
              }
              return dateStr;
            };
            return {
              soCCCD: parts[0] || '',
              cmnd: parts[1] || '',
              hoTen: parts[2] || '',
              ngaySinh: formatDate(parts[3]),
              gioiTinh: parts[4] || '',
              diaChi: parts[5] || '',
              ngayCap: formatDate(parts[6])
            };
          }
          return null;
        } catch (err) {
          return null;
        }
      };

      const startCamera = async () => {
        try {
          setDebugInfo('ƒêang y√™u c·∫ßu quy·ªÅn camera...');
          setMessage({ type: '', text: '' });
          setScanning(true);
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' }, width: 1280, height: 720 }
          });
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            streamRef.current = stream;
            scanningRef.current = true;
            await videoRef.current.play();
            setDebugInfo('Camera ƒëang ho·∫°t ƒë·ªông! ƒê∆∞a m√£ QR v√†o khung.');
            requestAnimationFrame(scanQRCode);
          }
        } catch (err) {
          console.error(err);
          setScanning(false);
          setDebugInfo('L·ªói camera: ' + err.message);
          setMessage({ type: 'error', text: 'Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn.' });
        }
      };

      const stopCamera = () => {
        scanningRef.current = false;
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        if (videoRef.current) videoRef.current.srcObject = null;
        setScanning(false);
        setDebugInfo('');
      };

      const scanQRCode = () => {
        if (!scanningRef.current || !videoRef.current || !canvasRef.current) return;

        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          if (typeof window.jsQR !== 'undefined') {
            const code = window.jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
            if (code && code.data) {
              setDebugInfo('ƒê√£ ph√°t hi·ªán m√£ QR: ' + code.data.substring(0, 50) + '...');
              const parsed = parseCCCDData(code.data);
              if (parsed) {
                setCccdData(parsed);
                stopCamera();
                setMessage({ type: 'success', text: 'Qu√©t m√£ th√†nh c√¥ng!' });
                return;
              } else {
                setDebugInfo('M√£ QR kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng CCCD.');
              }
            }
          }
        }

        if (scanningRef.current) requestAnimationFrame(scanQRCode);
      };

      const handleSubmit = () => {
        if (!cccdData || !maNV.trim()) {
          setMessage({ type: 'error', text: 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!' });
          return;
        }

        setSubmitting(true);

        const newRecord = {
          thoiGian: new Date().toLocaleString('vi-VN'),
          soCCCD: cccdData.soCCCD,
          cmnd: cccdData.cmnd || '',
          hoTen: cccdData.hoTen,
          ngaySinh: cccdData.ngaySinh,
          gioiTinh: cccdData.gioiTinh,
          diaChi: cccdData.diaChi,
          ngayCap: cccdData.ngayCap,
          maNV: maNV
        };

        fetch(GOOGLE_SHEET_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify(newRecord),
          headers: { "Content-Type": "application/json" }
        })
        .then(res => res.json())
        .then(data => {
          if(data.status === 'success'){
            setMessage({ type: 'success', text: 'ƒê√£ l∆∞u l√™n Google Sheets th√†nh c√¥ng!' });
            setCccdData(null);
            setMaNV('');
          } else {
            setMessage({ type: 'error', text: 'L·ªói khi l∆∞u d·ªØ li·ªáu: ' + data.message });
          }
          setSubmitting(false);
        })
        .catch(err => {
          console.error(err);
          setMessage({ type: 'error', text: 'L·ªói khi g·ª≠i d·ªØ li·ªáu!' });
          setSubmitting(false);
        });
      };

      const handleTestInput = () => {
        const testData = '075400109724|273719287|Ng√¥ Th·ªã Lan|12102006|Nam|165, T·ªï 43, Kp T√¢n Th·∫°nh 2, Bi√™n H√≤a, ƒê·ªìng Nai|28102024';
        const parsed = parseCCCDData(testData);
        if (parsed) {
          setCccdData(parsed);
          setMessage({ type: 'success', text: 'ƒê√£ load d·ªØ li·ªáu test!' });
        }
      };

      const handleCaptureImage = () => {
        if (!videoRef.current || !canvasRef.current) return;
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        setCapturedImage(canvas.toDataURL('image/png'));

        const imgData = context.getImageData(0, 0, canvas.width, canvas.height);
        if (typeof window.jsQR !== 'undefined') {
          const code = window.jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: "attemptBoth" });
          if (code && code.data) {
            const parsed = parseCCCDData(code.data);
            if (parsed) {
              setCccdData(parsed);
              stopCamera();
              setMessage({ type: 'success', text: 'Qu√©t m√£ th√†nh c√¥ng t·ª´ ·∫£nh!' });
            } else {
              setDebugInfo('M√£ QR kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng: ' + code.data.substring(0,100));
            }
          } else {
            setDebugInfo('Kh√¥ng ph√°t hi·ªán m√£ QR trong ·∫£nh.');
          }
        }
      };

      const handleReset = () => {
        setCccdData(null);
        setMaNV('');
        setMessage({ type: '', text: '' });
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-md mx-auto">
            <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
                <h1 className="text-2xl font-bold text-center">Qu√©t CCCD</h1>
                <p className="text-center text-blue-100 text-sm mt-1">H·ªá th·ªëng nh·∫≠n di·ªán nh√¢n vi√™n</p>
              </div>

              <div className="p-6">
                {debugInfo && <div className="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-xs"><strong>Debug:</strong> {debugInfo}</div>}
                {message.text && <div className={`mb-4 p-4 rounded-lg flex items-center gap-2 ${message.type==='success'?'bg-green-50 text-green-800':'bg-red-50 text-red-800'}`}><span className="text-sm">{message.text}</span></div>}

                {!scanning && !cccdData && (
                  <div className="space-y-3">
                    <button onClick={startCamera} className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition flex items-center justify-center gap-2">
                      Qu√©t m√£ QR CCCD
                    </button>
                    <button onClick={handleTestInput} className="w-full px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg font-medium hover:bg-gray-50 transition text-sm">
                      üß™ Test v·ªõi d·ªØ li·ªáu m·∫´u
                    </button>
                  </div>
                )}

                {scanning && (
                  <div className="mb-6">
                    <div className="relative bg-black rounded-lg overflow-hidden" style={{ aspectRatio: '4/3' }}>
                      <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                      <canvas ref={canvasRef} className="hidden" />
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-64 h-64 border-2 border-white rounded-lg opacity-70"></div>
                      </div>
                      <div className="absolute bottom-4 left-4 right-4 text-white text-center text-sm bg-black bg-opacity-50 p-2 rounded">
                        ƒê·∫∑t m√£ QR v√†o khung vu√¥ng
                      </div>
                    </div>
                    <div className="flex gap-2 mt-3">
                      <button onClick={handleCaptureImage} className="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg font-medium hover:bg-yellow-600 transition">üì∏ Ch·ª•p & Ph√¢n t√≠ch</button>
                      <button onClick={stopCamera} className="flex-1 px-4 py-3 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition">D·ª´ng qu√©t</button>
                    </div>
                    {capturedImage && (
                      <div className="mt-3">
                        <p className="text-sm font-medium mb-2">·∫¢nh v·ª´a ch·ª•p:</p>
                        <img src={capturedImage} alt="Captured" className="w-full rounded-lg border-2 border-yellow-400" />
                      </div>
                    )}
                  </div>
                )}

                {cccdData && (
                  <div className="space-y-4 mb-6">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <h3 className="font-semibold text-green-800 mb-3">Th√¥ng tin CCCD:</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex"><span className="font-medium w-32">S·ªë CCCD:</span><span>{cccdData.soCCCD}</span></div>
                        <div className="flex"><span className="font-medium w-32">S·ªë CMND c≈©:</span><span>{cccdData.cmnd || 'Kh√¥ng c√≥'}</span></div>
                        <div className="flex"><span className="font-medium w-32">H·ªç t√™n:</span><span>{cccdData.hoTen}</span></div>
                        <div className="flex"><span className="font-medium w-32">Ng√†y sinh:</span><span>{cccdData.ngaySinh}</span></div>
                        <div className="flex"><span className="font-medium w-32">Gi·ªõi t√≠nh:</span><span>{cccdData.gioiTinh}</span></div>
                        <div className="flex"><span className="font-medium w-32">ƒê·ªãa ch·ªâ:</span><span className="flex-1">{cccdData.diaChi}</span></div>
                        <div className="flex"><span className="font-medium w-32">Ng√†y c·∫•p:</span><span>{cccdData.ngayCap}</span></div>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        M√£ s·ªë nh√¢n vi√™n <span className="text-red-500">*</span>
                      </label>
                      <input type="text" value={maNV} onChange={(e)=>setMaNV(e.target.value)} placeholder="Nh·∫≠p m√£ NV" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                    </div>

                    <div className="flex gap-3">
                      <button onClick={handleReset} className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">Qu√©t l·∫°i</button>
                      <button onClick={handleSubmit} disabled={submitting} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition disabled:opacity-50">
                        {submitting ? 'ƒêang l∆∞u...' : 'L∆∞u'}
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<CCCDScanner />, document.getElementById('root'));
  </script>
</body>
</html>
